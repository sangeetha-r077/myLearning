<?xml version="1.0" encoding="UTF-8"?>

<project name="WigtDataPublisherServiceV1" default="all" basedir="..">

    <!-- Set Global Properties for this build -->

    <!-- Directory Setup -->
    <property name="basedir" value="."/>
    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="config.dir" value="${basedir}/config"/>
    <property name="build.dir" value="${basedir}/build"/>
    <property name="build.xbean.dir" value="${build.dir}/xbean-classes"/>
    <property name="source.xsd.dir" value="${basedir}/src/Schema"/>
    <property name="source.wss.dir" value="${basedir}/src/WSS"/>
    <property name="source.java.dir" value="${basedir}/src/Java"/>
    <property name="source.wsdl.dir" value="${basedir}/src/WSDL"/>
    <property name="websvc.dir" value="${basedir}/JavaWS"/>
    <property name="dest.JWSinterface.dir" value="${websvc.dir}/JWSinterface"/>
    <property name="dest.JWSimpl.dir" value="${websvc.dir}/JWSimplementation"/>
    <property name="assemble.dir" value="${basedir}/assemble"/>
    <property name="make.dir" value="${basedir}/make"/>
    <property name="dist.dir" value="${basedir}/dist"/>
    <property name="war.dir" value="${dist.dir}/Svc-WAR"/>
    <property name="ear.dir" value="${dist.dir}/Svc-EAR"/>
    <property name="bindings.dir" value="${config.dir}\bindings"/>

    <!-- WebService Definitions -->
    <property name="websvc.impl.dir" value="com\att\nis\esbcompass\websvc\impl"/>
    <property name="websvc.impl.package" value="com.att.nis.esbcompass.websvc.impl"/>
    <property name="websvc.impl.file" value="ESB_COMPASS_QUERY_SVC_cssngInterfaceEndpointImpl"/>
    <property name="manifest.class.path"
              value="WigtDataPublisherServiceV1.jar EventsRuleMapping.jar WigtEventNotificationDomainV1-1.0.jar WIGTEventListenerServiceV1_wsdl.jar service-xbeans.jar WigtNotificationInterfaceV1-1.0.jar"/>
    <property name="web.module.name" value="ESBAfCompassQryServiceV1ImplWar"/>
    <property name="project.ear.name" value="WigtDataPublisherServiceV1"/>
    <property name="wigt.ejb.intf" value="WigtNotificationInterfaceV1-1.0.jar"/>
    <!-- JAR Definitions -->
    <property name="compiled.wsdl.jar" value="${assemble.dir}/ESB_COMPASS_QUERY_SVC_wsdl.jar"/>
    <property name="esb.commons.jar" value="${lib.dir}/WigtNotificationInterfaceV1-1.0.jar"/>
    <property name="leaf.client.jar" value="${lib.dir}/LeafLoggingClient.jar"/>
    <property name="xbean.jar.dir" value="/opt/appl/esb/oracle/Middleware/modules"/>
    <property name="weblogic.home" value="/opt/appl/esb/oracle/Middleware/wlserver_10.3"/>

    <property name="xbean.jar" value="${xbean.jar.dir}/com.bea.core.xml.xmlbeans_2.2.0.0.jar"/>
    <property name="weblogic.jar" value="${weblogic.home}/server/lib/weblogic.jar"/>


    <!-- Task Definitions -->
    <taskdef name="xmlbean" classname="org.apache.xmlbeans.impl.tool.XMLBean" classpath="${xbean.jar}"/>
    <taskdef name="wsdlc" classname="weblogic.wsee.tools.anttasks.WsdlcTask" classpath="${weblogic.jar}"/>
    <taskdef name="jwsc" classname="weblogic.wsee.tools.anttasks.JwscTask" classpath="${weblogic.jar}"/>

    <!-- End of global properties -->

    <path id="build.class.path">
        <pathelement path="${weblogic.jar}"/>
        <pathelement path="${xbean.jar}"/>
        <pathelement path="${esb.commons.jar}"/>
        <pathelement path="${compiled.wsdl.jar}"/>
        <pathelement path="${leaf.client.jar}"/>
        <pathelement path="${lib.dir}/service-xbeans.jar"/>
        <pathelement path="${lib.dir}/AutoFormsClient.jar"/>
        <pathelement path="${lib.dir}/EventsRuleMapping.jar"/>
        <pathelement path="${lib.dir}/WigtEventNotificationDomainV1-1.0.jar"/>

        <pathelement path="${lib.dir}/WIGTEventListenerServiceV1_wsdl.jar"/>

    </path>

    <ant antfile="${make.dir}\BuildXMLBeans.xml" target="all" inheritAll="false"/>

    <!--<target name="all" depends="generate-from-wsdl,generate-from-svc,ejb-config-inject,createDeploy" />-->
    <target name="all" depends="ejb-config-inject,createDeploy"/>

    <target name="generate-from-wsdl">
        <delete dir="${dest.JWSimpl.dir}"/>
        <delete dir="${dest.JWSinterface.dir}"/>
        <mkdir dir="${dest.JWSimpl.dir}"/>
        <mkdir dir="${dest.JWSinterface.dir}"/>

        <wsdlc classpathref="build.class.path" srcWsdl="${source.wsdl.dir}/ESB_COMPASS_QUERY_SVC.wsdl"
               destJwsDir="${dest.JWSinterface.dir}" destImplDir="${dest.JWSimpl.dir}" type="JAXWS"
               packagename="${websvc.impl.package}">
            <binding dir="${bindings.dir}" includes="*.xml"/>
        </wsdlc>

        <copy todir="${assemble.dir}">
            <fileset dir="${dest.JWSinterface.dir}" includes="**/*.jar"/>
        </copy>
    </target>

    <target name="generate-from-svc">
        <delete dir="${build.dir}/stage-classes"/>
        <mkdir dir="${build.dir}/stage-classes"/>
        <delete dir="${war.dir}"/>
        <mkdir dir="${war.dir}"/>

        <javac srcdir="${source.java.dir}" destdir="${build.dir}/stage-classes" includes="**/*.java"
               classpathref="build.class.path" debug="on" failonerror="true"/>

        <jwsc classpathref="build.class.path" srcdir="${source.java.dir}" destdir="${war.dir}">
            <module name="${web.module.name}">
                <jws file="${websvc.impl.dir}\${websvc.impl.file}.java" generatedescriptors="true" type="JAXWS"
                     compiledwsdl="${compiled.wsdl.jar}"/>
                <fileset dir="${build.dir}/stage-classes">
                    <include name="**/*.class"/>
                </fileset>
            </module>
        </jwsc>
    </target>

    <target name="ejb-config-inject">
        <delete dir="${build.dir}/common-jar-classes"/>
        <mkdir dir="${build.dir}/common-jar-classes"/>
        <delete dir="${ear.dir}"/>
        <mkdir dir="${ear.dir}"/>

        <manifest file="${config.dir}/MANIFEST.MF">
            <attribute name="Built-By" value="WigtDataPublisherServiceV1"/>
            <attribute name="Created-By" value="Apache ANT 1.6"/>
            <attribute name="Class-Path" value="${manifest.class.path}"/>
        </manifest>

        <unzip src="${esb.commons.jar}" dest="${build.dir}/common-jar-classes"/>
        <jar jarfile="${esb.commons.jar}" basedir="${build.dir}/common-jar-classes" manifest="${config.dir}/MANIFEST.MF"
             update="false">
            <zipfileset dir="${config.dir}/" includes="ejb-jar.xml,weblogic-ejb-jar.xml" prefix="META-INF"/>
        </jar>
    </target>

    <target name="createDeploy">

        <mkdir dir="${build.dir}/stage-classes"/>
        <delete dir="${build.dir}/war-classes"/>
        <mkdir dir="${build.dir}/war-classes"/>
        <delete dir="${build.dir}/jar-classes"/>
        <mkdir dir="${build.dir}/jar-classes"/>
        <mkdir dir="${build.dir}/jar-classes/META-INF"/>
        <mkdir dir="${ear.dir}/META-INF"/>
        <mkdir dir="${ear.dir}/APP-INF/lib"/>
        <javac srcdir="${source.java.dir}" destdir="${build.dir}/stage-classes" includes="**/*.java"
               classpathref="build.class.path" debug="on" failonerror="true"/>
        <!--<unwar src="${war.dir}/${web.module.name}.war" dest="${build.dir}/war-classes" overwrite="true" />
        <copydir dest="${build.dir}/war-classes/WEB-INF/" src="${config.dir}/policies" />
        <copyfile dest="${build.dir}/war-classes/WEB-INF/web.xml" src="${config.dir}/web.xml" forceoverwrite="true" />

        <move todir="${build.dir}/jar-classes">
            <fileset dir="${build.dir}/war-classes/WEB-INF/classes" includes="**/*.class" />
        </move>
        <delete dir="${build.dir}/war-classes/WEB-INF/classes" />
        <war destfile="${ear.dir}/${web.module.name}.war" basedir="${build.dir}/war-classes" manifest="${config.dir}/MANIFEST.MF" webxml="${config.dir}/web.xml" />
-->
        <copyfile dest="${build.dir}/jar-classes/META-INF/MANIFEST.MF" src="${config.dir}/MANIFEST.MF"/>

        <jar destfile="${ear.dir}/APP-INF/lib/${project.ear.name}.jar" basedir="${build.dir}/stage-classes"
             manifest="${config.dir}/MANIFEST.MF"/>

        <copy todir="${ear.dir}">
            <fileset dir="${lib.dir}" includes="*.jar"/>
            <fileset dir="${assemble.dir}" includes="*.jar"/>
        </copy>

        <!--<copy overwrite="true" todir="${ear.dir}/META-INF">
            <fileset dir="${config.dir}" includes="ejb-jar.xml,weblogic-application.xml,weblogic-ejb-jar.xml" />
        </copy>-->
        <copy overwrite="true" todir="${ear.dir}/META-INF">
            <fileset dir="${config.dir}" includes="weblogic-application.xml"/>
        </copy>
        <ear destfile="${ear.dir}/${project.ear.name}.ear" basedir="${ear.dir}" manifest="${config.dir}/MANIFEST.MF"
             appxml="${config.dir}/application.xml" update="true"/>
    </target>
</project>